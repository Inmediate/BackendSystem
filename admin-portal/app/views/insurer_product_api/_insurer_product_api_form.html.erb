<div class="panel panel-default">
  <div class="panel-body">
    <%= form_for  @api, url: {action: action_name == 'new' || action_name == 'create' ? 'create' : 'update'}, html: { class: 'form' } do |f| %>

      <%= f.hidden_field :insurer_id, value: @insurer.id%>

      <div class="form-group <%= @is_pending && @pending_is_auth_api != @api.is_authentication ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :is_authentication, 'Is this an Authentication API?' %><br>
        <% if action_name == 'new'%>
          <%= f.check_box :is_authentication, id:"is_auth" %>
        <% else%>
          <%= f.check_box :is_authentication, id:"is_auth", checked: @is_pending || action_name == 'update' ? @pending_is_auth_api : @api.is_authentication %>
        <% end%>
        Check if yes
        <% if @is_pending && @pending_is_auth_api != @api.is_authentication  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.is_authentication %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["auth_token_key_name"] != @api.auth_token_key_name ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :auth_token_key_name, 'Authentication Token Key Name' %>
        <p><em>Required field if this is an Authentication API</em></p>
        <% if action_name == 'update'%>
          <%= f.text_field :auth_token_key_name, value: params[:insurer_product_api]['auth_token_key_name'], class: 'form-control', id: "auth_token_key_name", required: false %>
        <% else %>
          <%= f.text_field :auth_token_key_name, value: !@is_pending ? @api.auth_token_key_name : @api_pending["auth_token_key_name"], class: 'form-control', id: "auth_token_key_name", required: false %>
        <% end %>
        <% if @is_pending && @api_pending["name"] != @api.auth_token_key_name  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.auth_token_key_name %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["client_api_id"].to_s != @api.client_api_id.to_s  ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :client_api_id, 'Client API Mapping' %>
        <p><em>Not required if this is an Authentication API</em></p>
        <% if action_name == 'edit' %>
          <% if @is_pending %>
            <%= f.collection_select :client_api_id, @client_api, :id, :name, {prompt: '', selected: @api_pending["client_api_id"]  }, class: 'form-control', required: !@pending_is_auth_api, disabled: @pending_is_auth_api %>
          <% else %>
            <%= f.collection_select :client_api_id, @client_api, :id, :name, {prompt: '', selected: @api.client_api_id }, class: 'form-control', prompt: true, required: !@api.is_authentication, disabled: @api.is_authentication  %>
          <% end %>
        <% elsif action_name == 'update' %>
          <%= f.collection_select :client_api_id, @client_api, :id, :name, {prompt: '', selected: params[:insurer_product_api]['client_api_id'].to_i }, class: 'form-control', prompt: true, required: !@pending_is_auth_api, disabled: @pending_is_auth_api  %>
        <% else %>
          <%= f.collection_select :client_api_id, @client_api, :id, :name, {prompt: '', selected: @api.client_api_id  }, class: 'form-control', required: true %>
        <% end %>
        <% if @is_pending && @api_pending["client_api_id"].to_s  != @api.client_api_id.to_s   %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.client_api_id.nil? ? nil : ClientApi.find(@api.client_api_id).name %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["cache_policy"] != @api.cache_policy ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :cache_policy, 'Cache Policy' %>
        <% if action_name == 'update' %>
          <%= f.select :cache_policy, options_for_select([%w[Live Live], %w[Database Database]], { selected: params[:insurer_product_api]['cache_policy'] }), {}, class: 'form-control' %>
        <% else %>
          <%= f.select :cache_policy, options_for_select([%w[Live Live], %w[Database Database]], { selected:  !@is_pending ? @api.cache_policy : @api_pending["cache_policy"] }), {}, class: 'form-control' %>
        <% end %>
        <% if @is_pending && @api_pending["cache_policy"] != @api.cache_policy  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.cache_policy %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["cache_timeout"] != @api.cache_timeout.to_s ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :cache_timeout, 'Cache Timeout (Hours)' %>
        <% if action_name == 'update' %>
          <%= f.number_field :cache_timeout, value: params[:insurer_product_api]['cache_timeout'], class: 'form-control' %>
        <% else %>
          <%= f.number_field :cache_timeout, value: !@is_pending ? @api.cache_timeout : @api_pending["cache_timeout"], class: 'form-control' %>
        <% end %>
        <% if @is_pending && @api_pending["cache_timeout"] != @api.cache_timeout.to_s  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.cache_timeout %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["api_url"] != @api.api_url ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :api_url do %>
          API URL: <span>&#42;</span>
        <% end %>
        <% if action_name == 'update' %>
          <%= f.text_field :api_url, value: params[:insurer_product_api]['api_url'], class: 'form-control', required: true %>
        <% else %>
          <%= f.text_field :api_url, value: !@is_pending ? @api.api_url : @api_pending["api_url"], class: 'form-control', required: true %>
        <% end %>
        <% if @is_pending && @api_pending["api_url"] != @api.api_url  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.api_url %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["api_method"] != @api.api_method ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :api_method do %>
          Method: <span>&#42;</span>
        <% end %>
        <% if action_name == 'update' %>
          <%= f.select :api_method, options_for_select([%w[GET GET], %w[POST POST], %w[PUT PUT], %w[PATCH PATCH], %w[DELETE DELETE]], { selected: params[:insurer_product_api]['api_method'] }), {}, class: 'form-control' %>
        <% else %>
          <%= f.select :api_method, options_for_select([%w[GET GET], %w[POST POST], %w[PUT PUT], %w[PATCH PATCH], %w[DELETE DELETE]], { selected:  !@is_pending ? @api.api_method : @api_pending["api_method"] }), {}, class: 'form-control' %>
        <% end %>
        <% if @is_pending && @api_pending["api_method"] != @api.api_method  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.api_method %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["api_flavour"] != @api.api_flavour ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :api_flavour do %>
          API Flavor: <span>&#42;</span>
        <% end %>
        <% if action_name == 'update' %>
          <%= f.select :api_flavour, options_for_select([ ['Type 1 (No authentication)', 'Type 1'], ['Type 2 (Pre-shared authentication)', 'Type 2'], ['Type 3 (Via authentication API)', 'Type 3']], { selected: params[:insurer_product_api]['api_flavour'] }), {}, class: 'form-control' %>
        <% else %>
          <%= f.select :api_flavour, options_for_select([ ['Type 1 (No authentication)', 'Type 1'], ['Type 2 (Pre-shared authentication)', 'Type 2'], ['Type 3 (Via authentication API)', 'Type 3']], { selected:  !@is_pending ? @api.api_flavour : @api_pending["api_flavour"] }), {}, class: 'form-control' %>
        <% end %>
        <% if @is_pending && @api_pending["api_flavour"] != @api.api_flavour  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.api_flavour %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["auth_scheme_name"] != @api.auth_scheme_name ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :auth_scheme_name, 'Authentication Scheme Name' %>
        <p><em>Required if API Flavor is Type 2 or Type 3</em></p>
         <% if action_name == 'edit' %>
          <% if @is_pending%>
            <%= f.text_field :auth_scheme_name, value: @api_pending["auth_scheme_name"], class: 'form-control', required: @api_pending["api_flavour"] != 'Type 1', disabled: @api_pending["api_flavour"] == 'Type 1' %>
          <% else %>
            <%= f.text_field :auth_scheme_name, value: @api.auth_scheme_name, class: 'form-control', required: @api.api_flavour != 'Type 1', disabled: @api.api_flavour == 'Type 1' %>
          <% end %>
        <% elsif action_name == 'update' %>
          <%= f.text_field :auth_scheme_name, value: params[:insurer_product_api]['auth_scheme_name'], class: 'form-control', required: params[:insurer_product_api]['api_flavour'] != 'Type 1', disabled: params[:insurer_product_api]['api_flavour'] == 'Type 1' %>
        <% else %>
          <%= f.text_field :auth_scheme_name, value: @api.auth_scheme_name, class: 'form-control', required: false, disabled: true %>
        <% end %>
        <% if @is_pending && @api_pending["auth_scheme_name"] != @api.auth_scheme_name  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.auth_scheme_name %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["credential"] != @api.credential ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :credential, 'Pre-Shared Credential' %>
        <p><em>Required if API Flavor is Type 2</em></p>
        <% if action_name == 'edit' %>
          <% if @is_pending%>
            <%= f.text_field :credential, value: @api_pending["credential"], class: 'form-control', required: @api_pending["api_flavour"] == 'Type 2', disabled: @api_pending["api_flavour"] != 'Type 2' %>
          <% else %>
            <%= f.text_field :credential, value: @api.credential, class: 'form-control', required:  @api.api_flavour == 'Type 2', disabled:  @api.api_flavour != 'Type 2' %>
          <% end %>
        <% elsif action_name == 'update' %>
          <%= f.text_field :credential, value: params[:insurer_product_api]['credential'], class: 'form-control', required:  params[:insurer_product_api]['api_flavour'] == 'Type 2', disabled:  params[:insurer_product_api]['api_flavour'] != 'Type 2' %>
        <% else %>
          <%= f.text_field :credential, value: @api.credential, class: 'form-control', required: false, disabled: true %>
        <% end %>
          <% if @is_pending && @api_pending["credential"] != @api.credential  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.credential %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["auth_api"] != @api.auth_api ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :auth_api, 'Authentication API' %>
        <p><em>Required if API Flavor is Type 3</em></p>
        <% if action_name == 'edit' %>
          <% if @is_pending %>
            <%= f.collection_select :auth_api, @insurer.insurer_product_apis.where(status: true).where(activation_status: true).where(is_authentication: true), :id, :selection_name, {prompt: '', selected: @api_pending["auth_api"] }, class: 'form-control', required: @api_pending["api_flavour"] == 'Type 3', disabled: @api_pending["api_flavour"] != 'Type 3' %>
          <% else %>
            <%= f.collection_select :auth_api, @insurer.insurer_product_apis.where(status: true).where(activation_status: true).where(is_authentication: true), :id, :selection_name, {prompt: '', selected: @api.auth_api }, class: 'form-control', required: @api.api_flavour == "Type 3", disabled: @api.api_flavour != "Type 3" %>
          <% end %>
        <% elsif action_name == 'update' %>
          <%= f.collection_select :auth_api, @insurer.insurer_product_apis.where(status: true).where(activation_status: true).where(is_authentication: true), :id, :selection_name, {prompt: '', selected: params[:insurer_product_api]['auth_api'] }, class: 'form-control', required: params[:insurer_product_api]['api_flavour'] == "Type 3", disabled: params[:insurer_product_api]['api_flavour'] != "Type 3" %>
        <% else %>
          <%= f.collection_select :auth_api, @insurer.insurer_product_apis.where(status: true).where(activation_status: true).where(is_authentication: true), :id, :selection_name, {prompt: '', selected: @api.auth_api }, class: 'form-control', required: false, disabled: true %>
        <% end %>
        <% if @is_pending && @api_pending["auth_api"] != @api.auth_api  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.auth_api %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @api_pending["payload_type"] != @api.payload_type ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :payload_type do %>
          Payload Type: <span>&#42;</span>
        <% end %>
        <% if action_name == 'update' %>
          <%= f.select :payload_type, options_for_select([%w[JSON JSON], %w[XML XML]], { selected: params[:insurer_product_api]['payload_type'] }), {}, class: 'form-control' %>
        <% else %>
          <%= f.select :payload_type, options_for_select([%w[JSON JSON], %w[XML XML]], { selected:  !@is_pending ? @api.payload_type : @api_pending["payload_type"] }), {}, class: 'form-control' %>
        <% end %>
        <% if @is_pending && @api_pending["payload_type"] != @api.payload_type  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.payload_type %></span>
        <% end %>
      </div>

      <input type="hidden" value="<%= @insurer_mapping_id_array%>" id="insurer_mapping_id_array">
      <input type="hidden" value="<%= @insurer_mapping_name_array%>" id="insurer_mapping_name_array">

      <div class="form-group <%= @is_pending && @api_pending["payload"] != @api.payload ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :payload, 'Payload' %>
        <% if action_name == 'update' %>
          <%= f.text_area :payload, value: params[:insurer_product_api]['payload'], class: 'form-control', rows: "15" %>
        <% else %>
          <%= f.text_area :payload, value: !@is_pending ? @api.payload : @api_pending["payload"], class: 'form-control', rows: "15", style: "display: block;font-family: monospace;
white-space: pre;
    margin: 1em 0;" %>
        <% end %>
        <% if @is_pending && @api_pending["payload"] != @api.payload  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.payload %></span>
        <% end %>
      </div>

      <div class="form-group" >
        <%= f.label :payload_validation, 'Payload Validation' %>
        <table  class="table table-bordered" id="row_payload_validation">
          <thead >
          <tr class="active">
            <th>#</th>
            <th>Variable Name <span>&#42;</span></th>
            <th>Key Name Reference</th>
            <th>Validation</th>
            <th>Clone Mapping</th>
            <th>Mandatory?</th>
            <th>Enable Validation?</th>
            <th>Encrypted?</th>
            <th>Is Array?</th>
            <th>Belongs to Array Block</th>
            <th>Description</th>
            <th>Edit</th>
          </tr>
          </thead>
          <tbody>

          <% if action_name == 'edit' %>
            <% if @is_pending %>
              <% JSON.parse(@api_pending['payload_validation']).each_with_index do |payload_validation, index|%>
                <% position = index + 1%>
                <tr id="<%= position %>">
                  <td><%= position %></td>
                  <td id="row_payload_name_<%= position %>"><%= payload_validation['name'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][name]" id="payload_name_<%= position %>" value="<%= payload_validation['name'] %>">
                  <td id="row_payload_ref_name_<%= position %>" ><%= payload_validation['ref_name'] %></td>
                  <input type="hidden"  name="insurer_product_api[payload_validation][][ref_name]" id="payload_ref_name_<%= position %>" value="<%= payload_validation['ref_name'] %>">
                  <td style="white-space: pre-wrap;" id="row_payload_validation_<%= position %>" ><%= payload_validation['validation'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][validation]" id="payload_validation_<%= position %>" value="<%= payload_validation['validation'] %>">
                  <td id="row_payload_mapping_<%= position %>" ><%= Mapping.where(id: payload_validation['mapping']).any? ? Mapping.find(payload_validation['mapping']).name : nil %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][mapping]"  id="payload_mapping_id_<%= position %>" value="<%= payload_validation['mapping'] %>" >
                  <td id="row_payload_mandatory_<%= position %>" style="color: <%= payload_validation['mandatory'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['mandatory'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][mandatory]"  id="payload_mandatory_<%= position %>" value="<%= payload_validation['mandatory'] %>" >
                  <td id="row_payload_enable_validation_<%= position %>" style="color: <%= payload_validation['enable_validation'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['enable_validation'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][enable_validation]"  id="payload_enable_validation_<%= position %>" value="<%= payload_validation['enable_validation'] %>" >
                  <td id="row_payload_encrypted_<%= position %>" style="color: <%= payload_validation['encrypted'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['encrypted'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][encrypted]"  id="payload_encrypted_<%= position %>" value="<%= payload_validation['encrypted'] %>" >
                  <td id="row_payload_is_array_<%= position %>" style="color: <%= payload_validation['is_array'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['is_array'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][is_array]"  id="payload_is_array_<%= position %>" value="<%= payload_validation['is_array'] %>" >
                  <td id="row_payload_parent_array_<%= position %>" ><%= payload_validation['parent_array'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][parent_array]"  id="payload_parent_array_<%= position %>" value="<%= payload_validation['parent_array'] %>" >
                  <td id="row_payload_description_<%= position %>" ><%= payload_validation['description'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][description]"  id="payload_description_<%= position %>" value="<%= payload_validation['description'] %>" >
                  <td><a href="#" id="edit_payload_validation" data-toggle="modal" data-target="#<%= position %>_modal" ><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a></td>
                </tr>
              <% end %>
            <% else %>
              <% JSON.parse(@api.payload_validation).each_with_index do |payload_validation, index| %>
                <% position = index + 1%>
                <tr id="<%= position %>">
                  <td><%= position %></td>
                  <td id="row_payload_name_<%= position %>"><%= payload_validation['name'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][name]" id="payload_name_<%= position %>" value="<%= payload_validation['name'] %>">
                  <td id="row_payload_ref_name_<%= position %>" ><%= payload_validation['ref_name'] %></td>
                  <input type="hidden"  name="insurer_product_api[payload_validation][][ref_name]" id="payload_ref_name_<%= position %>" value="<%= payload_validation['ref_name'] %>">
                  <td style="white-space: pre-wrap;" id="row_payload_validation_<%= position %>" ><%= payload_validation['validation'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][validation]" id="payload_validation_<%= position %>" value="<%= payload_validation['validation'] %>">
                  <td id="row_payload_mapping_<%= position %>" ><%= payload_validation['mapping'].blank? ? nil : Mapping.find(payload_validation['mapping']).name %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][mapping]"  id="payload_mapping_id_<%= position %>" value="<%= payload_validation['mapping'] %>" >
                  <td id="row_payload_mandatory_<%= position %>" style="color: <%= payload_validation['mandatory'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['mandatory'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][mandatory]"  id="payload_mandatory_<%= position %>" value="<%= payload_validation['mandatory'] %>" >
                  <td id="row_payload_enable_validation_<%= position %>" style="color: <%= payload_validation['enable_validation'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['enable_validation'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][enable_validation]"  id="payload_enable_validation_<%= position %>" value="<%= payload_validation['enable_validation'] %>" >
                  <td id="row_payload_encrypted_<%= position %>" style="color: <%= payload_validation['encrypted'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['encrypted'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][encrypted]"  id="payload_encrypted_<%= position %>" value="<%= payload_validation['encrypted'] %>" >
                  <td id="row_payload_is_array_<%= position %>" style="color: <%= payload_validation['is_array'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['is_array'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][is_array]"  id="payload_is_array_<%= position %>" value="<%= payload_validation['is_array'] %>" >
                  <td id="row_payload_parent_array_<%= position %>" ><%= payload_validation['parent_array'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][parent_array]"  id="payload_parent_array_<%= position %>" value="<%= payload_validation['parent_array'] %>" >
                  <td id="row_payload_description_<%= position %>" ><%= payload_validation['description'] %></td>
                  <input type="hidden" name="insurer_product_api[payload_validation][][description]"  id="payload_description_<%= position %>" value="<%= payload_validation['description'] %>" >
                  <td><a href="#" id="edit_payload_validation" data-toggle="modal" data-target="#<%= position %>_modal" ><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a></td>
                </tr>
              <% end %>
            <% end %>
          <% elsif (action_name == 'create' || action_name == 'update') && !params[:insurer_product_api]['payload_validation'].nil? %>
            <% params[:insurer_product_api]['payload_validation'].each_with_index do |payload_validation, index| %>
              <% position = index + 1%>
              <tr id="<%= position %>">
                <td><%= position %></td>
                <td id="row_payload_name_<%= position %>"><%= payload_validation['name'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][name]" id="payload_name_<%= position %>" value="<%= payload_validation['name'] %>">
                <td id="row_payload_ref_name_<%= position %>" ><%= payload_validation['ref_name'] %></td>
                <input type="hidden"  name="insurer_product_api[payload_validation][][ref_name]" id="payload_ref_name_<%= position %>" value="<%= payload_validation['ref_name'] %>">
                <td style="white-space: pre-wrap;" id="row_payload_validation_<%= position %>" ><%= payload_validation['validation'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][validation]" id="payload_validation_<%= position %>" value="<%= payload_validation['validation'] %>">
                <td id="row_payload_mapping_<%= position %>" ><%= payload_validation['mapping'].blank? ? nil : Mapping.find(payload_validation['mapping']).name %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][mapping]"  id="payload_mapping_id_<%= position %>" value="<%= payload_validation['mapping'] %>" >
                <td id="row_payload_mandatory_<%= position %>" style="color: <%= payload_validation['mandatory'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['mandatory'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][mandatory]"  id="payload_mandatory_<%= position %>" value="<%= payload_validation['mandatory'] %>" >
                <td id="row_payload_enable_validation_<%= position %>" style="color: <%= payload_validation['enable_validation'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['enable_validation'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][enable_validation]"  id="payload_enable_validation_<%= position %>" value="<%= payload_validation['enable_validation'] %>" >
                <td id="row_payload_encrypted_<%= position %>" style="color: <%= payload_validation['encrypted'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['encrypted'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][encrypted]"  id="payload_encrypted_<%= position %>" value="<%= payload_validation['encrypted'] %>" >
                <td id="row_payload_is_array_<%= position %>" style="color: <%= payload_validation['is_array'] == 'true' ? '#5cb85c' : '#d9534f' %>;" ><%= payload_validation['is_array'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][is_array]"  id="payload_is_array_<%= position %>" value="<%= payload_validation['is_array'] %>" >
                <td id="row_payload_parent_array_<%= position %>" ><%= payload_validation['parent_array'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][parent_array]"  id="payload_parent_array_<%= position %>" value="<%= payload_validation['parent_array'] %>" >
                <td id="row_payload_description_<%= position %>" ><%= payload_validation['description'] %></td>
                <input type="hidden" name="insurer_product_api[payload_validation][][description]"  id="payload_description_<%= position %>" value="<%= payload_validation['description'] %>" >
                <td><a href="#" id="edit_payload_validation" data-toggle="modal" data-target="#<%= position %>_modal" ><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a></td>
              </tr>
            <% end %>
          <% end %>

          </tbody>
        </table>
        <!--<a class="btn btn-primary" id="add_payload_validation">Add Payload Validation</a>-->
        <a class="btn btn-primary" data-toggle="modal" data-target="#myModal" >Add Payload Validation</a>

      </div>


      <div class="form-group <%= @is_pending && @api_pending["RSA_encrypt_public_key"] != @api.RSA_encrypt_public_key ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :RSA_encrypt_public_key, 'RSA Encryption Public Key' %>
        <p><em>Required if there are variables to be encrypted</em></p>
        <% if action_name == 'update' %>
          <%= f.text_area :RSA_encrypt_public_key, value:  params[:insurer_product_api]['RSA_encrypt_public_key'], class: 'form-control', rows: "8" %>
        <% else %>
          <%= f.text_area :RSA_encrypt_public_key, value: !@is_pending ? @api.RSA_encrypt_public_key : @api_pending["RSA_encrypt_public_key"], class: 'form-control', rows: "8" %>
        <% end %>
        <% if @is_pending && @api_pending["RSA_encrypt_public_key"] != @api.RSA_encrypt_public_key  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.RSA_encrypt_public_key %></span>
        <% end %>
      </div>

      <div class="form-group <%= @is_pending && @pending_is_validation != @api.validation ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :validation, 'Require Validation' %><br>
        <% if action_name == 'edit' %>
          <%= f.check_box :validation, checked: @is_pending ? @pending_is_validation : @api.validation %>
        <% elsif action_name == 'update' %>
          <%= f.check_box :validation, checked:  @pending_is_validation %>
        <% else%>
          <%= f.check_box :validation %>
        <% end%>
        Check if yes
        <% if @is_pending && @pending_is_validation != @api.validation  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.validation %></span>
        <% end %>
      </div>

      <div class="form-group" >
        <%= f.label :static_header, 'Static Header' %>
        <table  class="table table-bordered" id="row_header">
          <thead >
          <tr class="active">
            <th>#</th>
            <th>Header Name</th>
            <th>Header Value</th>
            <th style="white-space: nowrap; width: 1%;" >Remove Header</th>
          </tr>
          </thead>
          <tbody>

          <% if action_name == 'edit' %>
            <% if @is_pending %>
              <% JSON.parse(@api_pending['headers']).each_with_index do |header, index|%>
                <tr id="payload_row">
                  <td><%= index + 1%></td>
                  <td><input type="text" name="insurer_product_api[headers][][head]" class="form-control" value="<%= header['head'] %>" ></td>
                  <td><input type="text" name="insurer_product_api[headers][][value]" class="form-control" value="<%= header['value'] %>" ></td>
                  <td><button type="button" class="btn btn-danger" id="remove_header">remove</button></td>
                </tr>
              <% end %>
            <% else %>
              <% JSON.parse(@api.headers).each_with_index do |header, index|%>
                <tr id="payload_row">
                  <td><%= index + 1%></td>
                  <td><input type="text" name="insurer_product_api[headers][][head]" class="form-control" value="<%= header['head'] %>" ></td>
                  <td><input type="text" name="insurer_product_api[headers][][value]" class="form-control" value="<%= header['value'] %>" ></td>
                  <td><button type="button" class="btn btn-danger" id="remove_header">remove</button></td>
                </tr>
              <% end %>
            <% end %>
          <% elsif (action_name == 'create' || action_name == 'update') && !params[:insurer_product_api]['headers'].nil? %>
            <% params[:insurer_product_api]['headers'].each_with_index do |header, index|%>
              <tr id="payload_row">
                <td><%= index + 1%></td>
                <td><input type="text" name="insurer_product_api[headers][][head]" class="form-control" value="<%= header['head'] %>" ></td>
                <td><input type="text" name="insurer_product_api[headers][][value]" class="form-control" value="<%= header['value'] %>" ></td>
                <td><button type="button" class="btn btn-danger" id="remove_header">remove</button></td>
              </tr>
            <% end %>
          <% end %>
          </tbody>
        </table>
        <a class="btn btn-primary" id="add_header">Add Static Header</a>
      </div>


      <div class="form-group <%= @is_pending && @api_pending["activation_status"] != @api.activation_status.to_s ? "alert alert-warning".html_safe : nil%> ">
        <%= f.label :activation_status, 'Activated' %>
        <% if action_name == 'new' || action_name == 'create'%>
          <%= f.select :activation_status, options_for_select([['Activated', true], ['Deactivated', false]], { selected: @api.activation_status  }), {}, class: 'form-control', disabled: !can_approve_reject_deactivate  %>
        <% elsif action_name == 'update' %>
          <%= f.select :activation_status, options_for_select([['Activated', true], ['Deactivated', false]], { selected: params[:insurer_product_api]['activation_status']  }), {}, class: 'form-control', disabled: !can_approve_reject_deactivate  %>
        <% else %>
          <%= f.select :activation_status, options_for_select([['Activated', true], ['Deactivated', false]], { selected: @is_pending ? @api_pending["activation_status"] : @api.activation_status  }), {}, class: 'form-control', disabled: !can_approve_reject_deactivate  %>
        <% end %>
        <% if @is_pending && @api_pending["activation_status"] != @api.activation_status.to_s  %>
          <span id="helpBlock" class="help-block">Current Value: <%= @api.activation_status ? "Activated" : "Deactivated" %></span>
        <% end %>
      </div>

      <%= f.submit action_name == 'new' || action_name == 'create' ? 'Submit' : 'Save Changes', class: 'btn btn-success' %>
      <%= link_to 'Cancel', "/insurer/edit/#{@insurer.id}", class: 'btn btn-warning' %>
    <% end %>

    <% if (action_name == 'edit' || action_name == 'update') && is_super_admin %>
      <p class='delete-button'><a href = "/insurer/<%= @insurer.id %>/api/delete/<%= @api.id %>" class="btn btn-danger" >Delete this Insurer Product API</a></p>
    <% end %>

  </div>
</div>



<!-- Modal -->

<!--Fresh form for add Payload Validation-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Add Payload Validation</h4>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label>Variable Name:<span>&#42;</span></label>
          <input type="text" class="form-control" value="" id="new_name">
        </div>

        <div class="form-group">
          <label>Key Name Reference:</label>
          <input type="text" class="form-control" value="" id="new_name_reference">
        </div>

        <div class="form-group">
          <label>Validation:</label>
          <p><em>Enter validations separated with new lines.</em></p>
          <textarea name="" class="form-control" id="new_validation" cols="30" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Mapping List:</label>
          <select name="new_mapping" id="new_mapping" class="form-control">
            <option value="" selected="selected"></option>
            <% @insurer_mapping.each do |map| %>
              <option value="<%= map['id'] %>"><%= Mapping.find(map['id']).name %></option>
            <% end %>
          </select>
        </div>

        <div class="form-group">
          <label>Mandatory?:</label><br>
          <input type="checkbox" value="true" id="new_mandatory" name="new_mandatory">
          Check if yes
        </div>

        <div class="form-group">
          <label>Enable Validation?:</label><br>
          <input type="checkbox" value="true" id="new_enable_validation" name="new_enable_validation">
          Check if yes
        </div>

        <div class="form-group">
          <label>Encrypted?:</label><br>
          <input type="checkbox" value="true" id="new_encrypted" name="new_encrypted">
          Check if yes
        </div>

        <div class="form-group">
          <label>Is Array?:</label><br>
          <input type="checkbox" value="true" id="new_is_array" name="new_is_array">
          Check if yes
        </div>

        <div class="form-group">
          <label>Belongs to Array Block:</label>
          <input type="text" class="form-control" value="" id="new_parent_array">
        </div>

        <div class="form-group">
          <label>Description:</label>
          <input type="text" class="form-control" value="" id="new_description">
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal"  id="add_payload_validation">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div id="modal_creation">
  <% if action_name == 'edit' %>
    <% if @is_pending %>
      <% JSON.parse(@api_pending['payload_validation']).each_with_index do |payload_validation, index| %>
        <% position = index + 1%>
        <div class="modal fade" id="<%= position %>_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Add Payload Validation</h4>
              </div>
              <div class="modal-body">

                <div class="form-group">
                  <label>Variable Name:<span>&#42;</span></label>
                  <input type="text" class="form-control" value="" id="form_payload_name_<%= position %>">
                </div>

                <div class="form-group">
                  <label>Key Name Reference:</label>
                  <input type="text" class="form-control" value="" id="form_payload_ref_name_<%= position %>">
                </div>

                <div class="form-group">
                  <label>Validation:</label>
                  <p><em>Enter validations separated with new lines.</em></p>
                  <textarea name="" class="form-control" id="form_payload_validation_<%= position %>" cols="30" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label>Mapping List:</label>
                  <select name="new_mapping" id="form_payload_mapping_<%= position %>" class="form-control">
                    <option value="" <%= @insurer_mapping.blank? ? 'selected="selected"' : nil %>></option>
                    <% @insurer_mapping.each do |map| %>
                      <option value="<%= map['id'] %>" <%= payload_validation['mapping'] == map['id']? 'selected' : nil %> ><%= Mapping.find(map['id']).name %></option>
                    <% end %>
                  </select>
                </div>

                <div class="form-group">
                  <label>Mandatory?:</label><br>
                  <input type="checkbox" value="true" id="form_payload_mandatory_<%= position %>" >
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Enable Validation?:</label><br>
                  <input type="checkbox" value="true" id="form_payload_enable_validation_<%= position %>" >
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Encrypted?:</label><br>
                  <input type="checkbox" value="true" id="form_payload_encrypted_<%= position %>">
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Is Array?:</label><br>
                  <input type="checkbox" value="true"  id="form_payload_is_array_<%= position %>" >
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Belongs to Array Block:</label>
                  <input type="text" class="form-control" value=""  id="form_payload_parent_array_<%= position %>">
                </div>

                <div class="form-group">
                  <label>Description:</label>
                  <input type="text" class="form-control" value=""  id="form_payload_description_<%= position %>" >
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger delete_payload_validation" id="<%= position %>" data-dismiss="modal">Remove</button>
                <button type="button" class="btn btn-primary update_payload_validation" id="<%= position %>" data-dismiss="modal" >Confirm</button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <% JSON.parse(@api.payload_validation).each_with_index do |payload_validation, index| %>
        <% position = index + 1%>
        <div class="modal fade" id="<%= position %>_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Add Payload Validation</h4>
              </div>
              <div class="modal-body">

                <div class="form-group">
                  <label>Variable Name:<span>&#42;</span></label>
                  <input type="text" class="form-control" value="" id="form_payload_name_<%= position %>">
                </div>

                <div class="form-group">
                  <label>Key Name Reference:</label>
                  <input type="text" class="form-control" value="" id="form_payload_ref_name_<%= position %>">
                </div>

                <div class="form-group">
                  <label>Validation:</label>
                  <p><em>Enter validations separated with new lines.</em></p>
                  <textarea name="" class="form-control" id="form_payload_validation_<%= position %>" cols="30" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label>Mapping List:</label>
                  <select name="new_mapping" id="form_payload_mapping_<%= position %>" class="form-control">
                    <option value="" <%= @insurer_mapping.blank? ? 'selected="selected"' : nil %>></option>
                    <% @insurer_mapping.each do |map| %>
                      <option value="<%= map['id'] %>" <%= payload_validation['mapping'] == map['id'] ? 'selected' : nil %> ><%= Mapping.find( map['id']).name %></option>
                    <% end %>
                  </select>
                </div>

                <div class="form-group">
                  <label>Mandatory?:</label><br>
                  <input type="checkbox" value="true" id="form_payload_mandatory_<%= position %>" >
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Enable Validation?:</label><br>
                  <input type="checkbox" value="true" id="form_payload_enable_validation_<%= position %>" >
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Encrypted?:</label><br>
                  <input type="checkbox" value="true" id="form_payload_encrypted_<%= position %>">
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Is Array?:</label><br>
                  <input type="checkbox" value="true"  id="form_payload_is_array_<%= position %>" >
                  Check if yes
                </div>

                <div class="form-group">
                  <label>Belongs to Array Block:</label>
                  <input type="text" class="form-control" value=""  id="form_payload_parent_array_<%= position %>">
                </div>

                <div class="form-group">
                  <label>Description:</label>
                  <input type="text" class="form-control" value=""  id="form_payload_description_<%= position %>" >
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger delete_payload_validation" id="<%= position %>" data-dismiss="modal">Remove</button>
                <button type="button" class="btn btn-primary update_payload_validation" id="<%= position %>" data-dismiss="modal" >Confirm</button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  <% elsif (action_name == 'create' || action_name == 'update') && !params[:insurer_product_api]['payload_validation'].nil? %>
    <% params[:insurer_product_api]['payload_validation'].each_with_index do |payload_validation, index| %>
      <% position = index + 1%>
      <div class="modal fade" id="<%= position %>_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="myModalLabel">Add Payload Validation</h4>
            </div>
            <div class="modal-body">

              <div class="form-group">
                <label>Variable Name:<span>&#42;</span></label>
                <input type="text" class="form-control" value="" id="form_payload_name_<%= position %>">
              </div>

              <div class="form-group">
                <label>Key Name Reference:</label>
                <input type="text" class="form-control" value="" id="form_payload_ref_name_<%= position %>">
              </div>

              <div class="form-group">
                <label>Validation:</label>
                <p><em>Enter validations separated with new lines.</em></p>
                <textarea name="" class="form-control" id="form_payload_validation_<%= position %>" cols="30" rows="3"></textarea>
              </div>

              <div class="form-group">
                <label>Mapping List:</label>
                <select name="new_mapping" id="form_payload_mapping_<%= position %>" class="form-control">
                  <option value="" selected="selected"></option>
                  <% @insurer_mapping.each do |map| %>
                    <option value="<%= map['id'] %>" <%= payload_validation['mapping'] == map['id'] ? 'selected' : nil %> ><%= Mapping.find( map['id']).name %></option>
                  <% end %>
                </select>
              </div>

              <div class="form-group">
                <label>Mandatory?:</label><br>
                <input type="checkbox" value="true" id="form_payload_mandatory_<%= position %>" >
                Check if yes
              </div>

              <div class="form-group">
                <label>Enable Validation?:</label><br>
                <input type="checkbox" value="true" id="form_payload_enable_validation_<%= position %>" >
                Check if yes
              </div>

              <div class="form-group">
                <label>Encrypted?:</label><br>
                <input type="checkbox" value="true" id="form_payload_encrypted_<%= position %>">
                Check if yes
              </div>

              <div class="form-group">
                <label>Is Array?:</label><br>
                <input type="checkbox" value="true"  id="form_payload_is_array_<%= position %>" >
                Check if yes
              </div>

              <div class="form-group">
                <label>Belongs to Array Block:</label>
                <input type="text" class="form-control" value=""  id="form_payload_parent_array_<%= position %>">
              </div>

              <div class="form-group">
                <label>Description:</label>
                <input type="text" class="form-control" value=""  id="form_payload_description_<%= position %>" >
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger delete_payload_validation" id="<%= position %>" data-dismiss="modal">Remove</button>
              <button type="button" class="btn btn-primary update_payload_validation" id="<%= position %>" data-dismiss="modal" >Confirm</button>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

</div>